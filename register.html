<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar - Perpustakaan Digital</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>
<body class="body-flex-col">

<div class="navbar">
  <div class="nav-wrap">
    <div class="brand">
      <img src="assets/logo-mandala.jpg" alt="Logo">
      <span class="brand-title">Perpustakaan Digital</span>
    </div>
  </div>
</div>

<section class="hero hero-flex">
  <div class="hero-content">
    <div class="hero-text">
      <h1>ğŸ“š Bergabunglah dengan Perpustakaan Digital</h1>
      <p>Daftar sebagai member untuk meminjam buku, melihat riwayat, dan mengelola akun Anda.</p>
    </div>

    <div class="auth-card">
      <div class="login-text-center">
        <span class="login-icon">ğŸ“</span>
        <h2 class="login-title">Daftar Akun</h2>
        <p class="login-subtitle">Isi data Anda untuk membuat akun member</p>
      </div>

      <div id="registerMessage"></div>

      <div class="form-group">
        <label for="nama">Nama Lengkap</label>
        <input id="nama" placeholder="Masukkan nama lengkap" type="text">
        <small class="input-error" id="namaError"></small>
      </div>

      <div class="form-group">
        <label for="nim">NIM</label>
        <input id="nim" placeholder="Masukkan NIM (tanpa spasi)" type="text">
        <small class="input-error" id="nimError"></small>
      </div>

      <div class="form-group">
        <label for="usernameReg">Username</label>
        <input id="usernameReg" placeholder="Pilih username" type="text">
        <small class="input-error" id="usernameError"></small>
        <small class="input-status" id="usernameStatus"></small>
      </div>

      <div class="form-group">
        <label for="passwordReg">Password</label>
        <input id="passwordReg" type="password" placeholder="Buat password">
        <small class="input-error" id="passwordError"></small>
      </div>

      <div class="form-group">
        <label for="passwordConfirm">Konfirmasi Password</label>
        <input id="passwordConfirm" type="password" placeholder="Ulangi password">
        <small class="input-error" id="confirmError"></small>
      </div>

      <button id="registerBtn" class="login-btn">âœ… Daftar Sekarang</button>

      <hr class="login-divider">

      <div class="login-link-section">
        <p class="login-link-text">
          Sudah punya akun? <a href="index.html" class="login-link">Masuk di sini</a>
        </p>
      </div>

    </div>
  </div>
</section>

<footer>
  <p>Â© 2026 Perpustakaan Digital - Semua Hak Dilindungi</p>
</footer>

<script>
const API_URL = 'https://perpustakaan-deploy-production.up.railway.app/api';

function showNotification(message, type = 'info') {
  const container = document.getElementById('registerMessage');
  const div = document.createElement('div');
  const colors = {
    success: '#d4edda #155724 #c3e6cb',
    error: '#f8d7da #721c24 #f5c6cb',
    warning: '#fff3cd #856404 #ffeaa7',
    info: '#d1ecf1 #0c5460 #bee5eb'
  };
  const [bg, text, border] = colors[type].split(' ');
  div.style.cssText = `background: ${bg}; color: ${text}; padding: 12px 16px; border-radius: 5px; border-left: 4px solid ${border}; margin-bottom: 15px; font-weight: 500; animation: slideIn 0.3s ease;`;
  div.textContent = message;
  container.innerHTML = '';
  container.appendChild(div);
  setTimeout(() => {
    div.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => container.innerHTML = '', 300);
  }, 4000);
}

async function registerMember() {
  const nama = document.getElementById('nama').value.trim();
  const nim = document.getElementById('nim').value.trim();
  const username = document.getElementById('usernameReg').value.trim();
  const password = document.getElementById('passwordReg').value;
  const confirm = document.getElementById('passwordConfirm').value;

  // Run validations before sending
  clearFieldErrors();
  const valid = validateAll({ nama, nim, username, password, confirm });
  if (!valid) return;

  const btn = document.getElementById('registerBtn');
  btn.disabled = true;
  btn.textContent = 'â³ Sedang mendaftar...';

  try {
    const res = await fetch(`${API_URL}/user/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nama, nim, username, password })
    });

    const result = await res.json();

    if (!res.ok) {
      showNotification(result.error || 'Pendaftaran gagal', 'error');
      btn.disabled = false;
      btn.textContent = 'âœ… Daftar Sekarang';
      return;
    }

    showNotification('Registrasi berhasil. Silakan login.', 'success');
    setTimeout(() => { window.location.href = 'index.html'; }, 1400);
  } catch (err) {
    console.error('Register error:', err);
    showNotification('Gagal terhubung ke server.', 'error');
    btn.disabled = false;
    btn.textContent = 'âœ… Daftar Sekarang';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('registerBtn').addEventListener('click', registerMember);

  // real-time validation
  document.getElementById('nama').addEventListener('input', () => validateNama());
  document.getElementById('nim').addEventListener('input', () => validateNIM());
  document.getElementById('usernameReg').addEventListener('input', () => validateUsername());
  document.getElementById('passwordReg').addEventListener('input', () => validatePassword());
  document.getElementById('passwordConfirm').addEventListener('input', () => validateConfirm());
  document.getElementById('passwordConfirm').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') registerMember();
  });
});

// Validation helpers
function setFieldError(id, message) {
  const el = document.getElementById(id);
  const err = document.getElementById(id + 'Error');
  if (err) err.textContent = message || '';
  if (el) el.style.borderColor = message ? '#d9534f' : '#ddd';
}

function clearFieldErrors() {
  ['nama','nim','username','password','confirm'].forEach(k => {
    const err = document.getElementById(k + 'Error');
    if (err) err.textContent = '';
  });
  ['nama','nim','usernameReg','passwordReg','passwordConfirm'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.borderColor = '#ddd';
  });
}

function validateNama() {
  const v = document.getElementById('nama').value.trim();
  if (v.length < 3) {
    setFieldError('nama', 'Nama minimal 3 karakter');
    return false;
  }
  setFieldError('nama', '');
  return true;
}

function validateNIM() {
  const v = document.getElementById('nim').value.trim();
  // Allow only digits, typical NIM length 6-12
  if (!/^[0-9]{6,12}$/.test(v)) {
    setFieldError('nim', 'NIM harus berupa 6-12 digit angka');
    return false;
  }
  setFieldError('nim', '');
  return true;
}

function validateUsername() {
  const v = document.getElementById('usernameReg').value.trim();
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(v)) {
    setFieldError('username', 'Username 3-20 karakter, huruf/angka/underscore');
    return false;
  }
  setFieldError('username', '');
  // If format OK, request availability check (debounced)
  debouncedCheckUsername(v);
  return true;
}

// Debounce helper and availability check
let usernameCheckTimer = null;
function debouncedCheckUsername(value) {
  const statusEl = document.getElementById('usernameStatus');
  if (!value) {
    if (statusEl) statusEl.textContent = '';
    return;
  }
  if (usernameCheckTimer) clearTimeout(usernameCheckTimer);
  usernameCheckTimer = setTimeout(() => checkUsernameAvailability(value), 500);
}

async function checkUsernameAvailability(username) {
  const statusEl = document.getElementById('usernameStatus');
  try {
    statusEl.textContent = 'Memeriksa ketersediaan...';
    const res = await fetch(`${API_URL}/user/check-username?username=${encodeURIComponent(username)}`);
    if (!res.ok) {
      statusEl.textContent = '';
      return;
    }
    const data = await res.json();
    if (data.available) {
      statusEl.style.color = '#155724';
      statusEl.textContent = 'Username tersedia âœ“';
    } else {
      statusEl.style.color = '#721c24';
      statusEl.textContent = 'Username sudah terpakai';
      setFieldError('username', 'Username sudah terpakai');
    }
  } catch (err) {
    statusEl.textContent = '';
  }
}

function validatePassword() {
  const v = document.getElementById('passwordReg').value;
  // At least 8 chars, letters and numbers
  if (v.length < 8 || !/[0-9]/.test(v) || !/[A-Za-z]/.test(v)) {
    setFieldError('password', 'Password minimal 8 karakter, kombinasi huruf & angka');
    return false;
  }
  setFieldError('password', '');
  return true;
}

function validateConfirm() {
  const p = document.getElementById('passwordReg').value;
  const c = document.getElementById('passwordConfirm').value;
  if (p !== c) {
    setFieldError('confirm', 'Konfirmasi password tidak cocok');
    return false;
  }
  setFieldError('confirm', '');
  return true;
}

function validateAll({ nama, nim, username, password, confirm }) {
  let ok = true;
  if (!validateNama()) ok = false;
  if (!validateNIM()) ok = false;
  if (!validateUsername()) ok = false;
  if (!validatePassword()) ok = false;
  if (!validateConfirm()) ok = false;

  if (!ok) {
    showNotification('Periksa kembali input yang berwarna merah.', 'error');
  }
  return ok;
}

// animation helpers (copied from index)
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
  @keyframes slideOut { from { opacity: 1; transform: translateY(0);} to { opacity: 0; transform: translateY(-10px);} }
  button:disabled { opacity: 0.6; cursor: not-allowed; }
`;
document.head.appendChild(style);
</script>

</body>
</html>
